#!/bin/bash

PKG=$2
PKGS=$ROOT/pkgs

BASE=$PWD
NONO=$BASE/nono

config() {
  [[ -z $ROOT ]] && \
    ROOT=$(dirname $PWD)

  [[ -d $ROOT/pkg ]] || \
    die "invalid root"

  [[ -z $INSTALL ]] && \
    INSTALL=$ROOT

  SRC=$ROOT/src
  PKGDIR=$ROOT/pkg/$PKG
}

pkg_open() {
  config

  [[ -e $PKGDIR ]] && \
    SMALL=yes

  [[ -d $PKGDIR ]] && \
    SMALL=no

  [[ -z $SMALL ]] && \
    die "package $PKG does not exist"
}

pkg() {
  pkg_open

  if [[ -e $BASE/config ]]; then
    . $BASE/config
  elif [[ -e $SRC/config ]]; then
    . $SRC/config
  fi

  [[ -z $CC ]] && CC=gcc

  [[ -e /bin/$CC ]] || \
    die "missing compiler: $CC"

  if [[ $SMALL = yes ]]; then
    PKGFILE=$PKGDIR
  else
    PKGFILE=$PKGDIR/build
    FILES=$PKGDIR/files
    PATCHES=$PKGDIR/patches
    STUFF=$PKGDIR/stuff
  fi

  . $PKGFILE

  if [[ ! -z "$name" ]] && [[ $name != *" "* ]]; then
    name=${name,,}
    PKG=$name
    unset $name
  fi

  GIT=no

  if [[ ! -z $src ]]; then
    FILENAME=$(basename $src)

    if [[ $src == *"git"* ]] && [[ $FILENAME != *"."* ]]; then
      GIT=yes
    fi
  fi

  if [[ $GIT = yes ]]; then
    PKGTYPE=git
  elif [[ ! -z $src ]]; then
    [[ -z $type ]] && \
      die "missing type in package $PKG"

    PKGTYPE=normal
  elif [[ ! -z $deps ]]; then
    PKGTYPE=group
  else
    die "empty package: $PKG"
  fi

  if [[ $PKGTYPE = normal ]] || [[ $PKGTYPE = git ]]; then
    [[ -z $files ]] && [[ $DEBUG != yes ]] && \
      die "missing files setting"
  fi

  if [[ -z $ver ]]; then
    NAME=$PKG
  else
    NAME=$PKG-$ver
  fi

  BUILD=$SRC/build

  if [[ $PKGTYPE = normal ]]; then
    DL=$SRC/dl

    FILE=$DL/$FILENAME
    WORK=$BUILD/$NAME
  elif [[ $PKGTYPE = git ]]; then
    WORK=$BUILD/$NAME

    unset $FILENAME
    unset $type
  elif [[ $PKGTYPE = group ]]; then
    unset $ver
  fi

  local preffered=$(($(nproc)+1))

  if [[ -z $JOBS ]] || (($JOBS > $preffered)); then
    JOBS=$preffered
  fi

  ARCH=x86_64
  TARGET=$ARCH-linux-musl
  HOST=$($CC -dumpmachine)

  DESTDIR=$ROOT

  CONFIGURE="./configure --prefix=$PREFIX"
  MAKE="make -j$JOBS"

  BIN_PREFIX=$PREFIX/bin
  BIN=$ROOT$BIN_PREFIX

  ETC_PREFIX=$PREFIX/etc
  ETC=$ROOT$ETC_PREFIX

  INCLUDE_PREFIX=$PREFIX/include
  INCLUDE=$ROOT$INCLUDE_PREFIX

  LIB_PREFIX=$PREFIX/lib
  LIB=$ROOT$LIB_PREFIX

  SHARE_PREFIX=$PREFIX/share
  SHARE=$ROOT$LIB_PREFIX

  MAN_PREFIX=$SHARE_PREFIX/man
  MAN=$ROOT$MAN_PREFIX

  CFLAGS="-fno-unwind-tables -fno-asynchronous-unwind-tables -Wa,--noexecstack -fno-math-errno"
  LDFLAGS="-Wl,-z,relro,-z,now -Wl,-z,text"

  [[ -z $OPT ]] && OPT=yes
  [[ -z $SECURE ]] && SECURE=yes

  if [[ $OPT = yes ]]; then
    CFLAGS="$CFLAGS -O3 -fstrength-reduce -fthread-jumps -fcse-follow-jumps -fcse-skip-blocks -frerun-cse-after-loop -fexpensive-optimizations -fforce-addr -fomit-frame-pointer"
  else
    CFLAGS="$CFLAGS -Os -g0 -fdata-sections -ffunction-sections"
    LDFLAGS="$LDFLAGS -Wl,--gc-sections"
  fi

  if [[ $SECURE = yes ]]; then
    CFLAGS="$CFLAGS -fPIE -fstack-protector"
    LDFLAGS="$LDFLAGS -fpie"
  fi

  if [[ $STATIC = yes ]]; then
    LDFLAGS="$LDFLAGS -static"
  fi

  if [[ -z $SILENT ]]; then
    if [[ $DEBUG = yes ]]; then
      SILENT=no
    else
      SILENT=yes
    fi
  fi

  unset $OPT
  unset $SECURE

  export PREFIX DESTDIR
  export CFLAGS LDFLAGS
}

pkg_extract() {
  cd $DL

  if [[ $type != "zip" ]]; then
    mkdir $WORK
  fi

  case $FILENAME in
  *.zip) unzip $FILENAME -d $WORK &>/dev/null ; ;;
  *.tgz|*.gz) tar xzvf $FILENAME -C $WORK --strip-components 1 &>/dev/null ; ;;
  *.tbz2|*.bz2) tar xjvf $FILENAME -C $WORK --strip-components 1 &>/dev/null ; ;;
  *.xz) tar xf $FILENAME -C $WORK --strip-components 1 &>/dev/null ; ;;
  esac
}

pkg_download() {
  info "downloading $PKG"

  if [[ $GIT = yes ]]; then
    cd $BUILD

    if [[ $SILENT = yes ]]; then
      git clone $src $NAME &>/dev/null
    else
      git clone $src $NAME
    fi
  else
    cd $DL

    if [[ $SILENT = yes ]]; then
      wget --no-check-certificate $src -O $FILENAME &>/dev/null
    else
      wget --no-check-certificate $src -O $FILENAME
    fi
  fi
}

pkg_configure() {
  info "configuring $PKG"

  if ! fn_exists configure; then
    if [[ -e CMakeLists.txt ]]; then
      mkdir -p build
      cd build

      if [[ $SILENT = yes ]]; then
        cmake .. &>/dev/null
      else
        cmake ..
      fi
    elif [[ -e configure ]]; then
      grep -q '--prefix' configure &>/dev/null

      if [ $? -eq 0 ]; then
        $CONFIGURE
      else
        ./configure
      fi
    fi
  else
    if [[ $SILENT = yes ]]; then
      configure &>/dev/null
    else
      configure
    fi
  fi
}

pkg_build() {
  info "compiling $NAME"

  if [[ -d $PATCHES ]]; then
    for patch in $PATCHES/*; do
      patch -p1 < $patch &>/dev/null
    done
  fi

  if ! fn_exists build; then
    if [[ -e Makefile ]]; then
      if [[ $SILENT = yes ]]; then
        $MAKE &>/dev/null
      else
        $MAKE
      fi
    else
      die "no build() in package $PKG"
    fi
  else
    if [[ $SILENT = yes ]]; then
      build &>/dev/null
    else
      build
    fi
  fi

  local error=yes

  for file in "${files[@]}"; do
    [[ -d $file ]] || [[ -e $file ]] && error=no
  done

  [[ $error = yes && $DEBUG != yes ]] && \
    die "build error on $PKG package"
}

pkg_package() {
  info "packaging $NAME"

  if ! fn_exists install; then
    if [[ -e Makefile ]]; then
      grep -q 'install:' Makefile &>/dev/null

      if [ $? -eq 0 ]; then
        $MAKE install
      fi
    fi
  else
    if [[ $SILENT = yes ]]; then
      install &>/dev/null
    else
      install
    fi
  fi
}

pkg_install() {
  pkg

  if [[ $PKGTYPE = normal ]] || [[ $PKGTYPE = git ]]; then
    if pkg_exists $PKG; then
      die "package $PKG is already installed"
    fi

    for dep in "${deps[@]}"; do
      if ! pkg_exists $dep; then
        sh $NONO -i $dep
      fi
    done

    local installed=no

    if [[ -d $WORK ]]; then
      cd $WORK
      for file in "${files[@]}"; do
        [[ -d $file ]] || [[ -e $file ]] && installed=yes
      done
      cd $BASE
    fi

    if [[ $installed = yes ]]; then
      info "installed missing built package: $PKG"
      echo $PKG >> $PKGS
      return
    fi

    info "installing $NAME"
  fi

  if [[ $PKGTYPE = normal ]]; then
    if [[ ! -d $WORK ]] && [[ ! -e $FILE ]]; then
      pkg_download
    fi

    if [[ ! -e $FILE ]]; then
      die "failed to download pkg: $PKG"
    elif [[ ! -d $WORK ]]; then
      pkg_extract
    fi

    if [[ ! -d $WORK ]]; then
      die "failed to extract package: $PKG"
    elif [[ -d $FILES ]]; then
      yes | \cp -rf $FILES/* $WORK
    fi

    cd $WORK

    pkg_configure
    pkg_build
    pkg_package
  elif [[ $PKGTYPE = git ]]; then
    if [[ ! -d $WORK ]]; then
      pkg_download
    fi

    if [[ ! -d $WORK ]]; then
      die "failed to clone $NAME"
    else
      if [[ -d $FILES ]]; then
        yes | \cp -rf $FILES/* $WORK
      fi

      cd $WORK

      pkg_build
      pkg_configure
      pkg_package
    fi
  else
    if pkg_exists $PKG; then
      found=no

      for dep in "${deps[@]}"; do
        if ! pkg_exists $dep; then
          found=yes
          sh $NONO -i $dep
        fi
      done

      if [[ $found = no ]]; then
        info "nothing to do"
      fi

      return
    else
      #info "installing package group: $NAME"

      for dep in "${deps[@]}"; do
        sh $NONO -i $dep
        if ! pkg_exists $dep; then
          return
        fi
      done

      #info "package group $PKG installed successfully"
    fi
  fi

  echo $PKG >> $PKGS

  if [[ $PKGTYPE != group ]]; then
    info "package $PKG installed successfully"
  fi
}

pkg_exists() {
  while read line; do
    if [[ $line == $1 ]]; then
      return 0
    fi
  done < $PKGS
  return 1
}

pkg_remove() {
  pkg

  if fn_exists remove; then
    if remove; then
      sed -i "/$PKG/d" $PKGS
    fi
  fi
}

pkg_info() {
  pkg_open

  if [[ $SMALL = yes ]]; then
    PKGFILE=$PKGDIR
  else
    PKGFILE=$PKGDIR/build
  fi

  . $PKGFILE

  [[ -z $desc ]] && \
    die "no info found"

  echo $desc
}

function cecho(){
    local exp=$1;
    local color=$2;
    if ! [[ $color =~ '^[0-9]$' ]] ; then
       case $(echo $color | tr '[:upper:]' '[:lower:]') in
        black) color=0 ;;
        red) color=1 ;;
        green) color=2 ;;
        yellow) color=3 ;;
        blue) color=4 ;;
        magenta) color=5 ;;
        cyan) color=6 ;;
        white|*) color=7 ;; # white or invalid color
       esac
    fi
    tput setaf $color;
    echo $exp;
    tput sgr0;
}

info() {
  cecho "> $@" red
}

die() {
  info "$@"
  exit 1
}

help() {
  info "nono -i package: install"
  info "nono -r package: remove"
  info "nono -I package: info"
  info "nono -e package: exists"
}

[[ -z $PKG ]] && \
  die "provide a package name"

fn_exists() {
  if type $1 2>/dev/null | grep -q 'function'; then
    return 0
  fi
  return 1
}

case $1 in
-i) pkg_install ; ;;
-r) pkg_remove ; ;;
-I) pkg_info ; ;;
-e) exit $(pkg_exists $PKG) ; ;;
*) help ; ;;
esac